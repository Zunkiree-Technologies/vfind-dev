// State
const [bookmarked, setBookmarked] = useState(false);

// Load token and profile ID
useEffect(() => {
  const token = localStorage.getItem("token");
  const profileId = localStorage.getItem("nurse_profile_id");

  if (token && profileId) {
    setAuthToken(token);
    setNurseProfileId(Number(profileId));
  }
}, []);

// Check if job is already bookmarked
useEffect(() => {
  const fetchBookmarkStatus = async () => {
    if (!id || !authToken) return;

    try {
      const res = await fetch(
        "https://x76o-gnx4-xrav.a2.xano.io/api:vUfT8k87/fetch_jobSaved_status",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${authToken}`,
          },
          body: JSON.stringify({ jobs_id: id.toString() }),
        }
      );

      const data = await res.json();
      setBookmarked(Array.isArray(data) && data.length > 0);
    } catch (err) {
      console.error("Error fetching bookmark status:", err);
      setBookmarked(false);
    }
  };

  fetchBookmarkStatus();
}, [id, authToken]);

// Toggle bookmark
const handleBookmarkToggle = async () => {
  if (!id || !nurseProfileId) return;
  if (!authToken) return alert("Please log in to save jobs");

  try {
    if (!bookmarked) {
      // Save job
      const payload = { nurse_profiles_id: nurseProfileId, jobs_id: Number(id), status: "" };
      const res = await fetch(
        "https://x76o-gnx4-xrav.a2.xano.io/api:vUfT8k87/jobssaved",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${authToken}`,
          },
          body: JSON.stringify(payload),
        }
      );

      if (!res.ok) throw new Error("Failed to save job");
      setBookmarked(true);
    } else {
      // Remove saved job
      const fetchRes = await fetch(
        "https://x76o-gnx4-xrav.a2.xano.io/api:vUfT8k87/fetch_jobSaved_status",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${authToken}`,
          },
          body: JSON.stringify({ jobs_id: id.toString() }),
        }
      );

      const data = await fetchRes.json();
      const savedJobId = data?.[0]?.id;
      if (!savedJobId) throw new Error("Saved job ID not found");

      const deleteRes = await fetch(
        `https://x76o-gnx4-xrav.a2.xano.io/api:vUfT8k87/jobssaved/${savedJobId}`,
        {
          method: "DELETE",
          headers: { Authorization: `Bearer ${authToken}` },
        }
      );

      if (!deleteRes.ok) throw new Error("Failed to remove saved job");
      setBookmarked(false);
    }
  } catch (err) {
    console.error(err);
    alert(err instanceof Error ? err.message : "An error occurred");
  }
};
